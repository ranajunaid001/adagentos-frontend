<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdAgentOS - AI Performance Analyst</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #e5e5e5; border-radius: 3px; }
    .markdown-content h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: #111827; }
    .markdown-content p { margin-bottom: 0.75rem; line-height: 1.6; }
    .markdown-content ol, .markdown-content ul { margin-bottom: 0.75rem; margin-left: 1.5rem; }
    .markdown-content li { margin-bottom: 0.5rem; line-height: 1.6; }
    .markdown-content strong { font-weight: 600; color: #1f2937; }
    .chart-container { position: relative; height: 300px; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Chart Component
    function ChartDisplay({ metrics }) {
      const roasChartRef = useRef(null);
      const spendRevenueChartRef = useRef(null);
      const conversionChartRef = useRef(null);
      const roasChartInstance = useRef(null);
      const spendRevenueChartInstance = useRef(null);
      const conversionChartInstance = useRef(null);

      useEffect(() => {
        if (!metrics || Object.keys(metrics).length === 0) return;

        const platforms = Object.keys(metrics);
        const colors = {
          TikTok: '#000000',
          Instagram: '#E4405F',
          Facebook: '#1877F2',
          YouTube: '#FF0000',
          Snapchat: '#FFFC00'
        };

        // ROAS Chart
        if (roasChartRef.current) {
          if (roasChartInstance.current) {
            roasChartInstance.current.destroy();
          }
          
          const ctx = roasChartRef.current.getContext('2d');
          roasChartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: platforms,
              datasets: [{
                label: 'ROAS',
                data: platforms.map(p => metrics[p].roas),
                backgroundColor: platforms.map(p => colors[p] || '#6B7280'),
                borderRadius: 8,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Return on Ad Spend (ROAS) by Platform',
                  font: { size: 14, weight: 'normal' }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value + 'x';
                    }
                  }
                }
              }
            }
          });
        }

        // Spend vs Revenue Chart
        if (spendRevenueChartRef.current) {
          if (spendRevenueChartInstance.current) {
            spendRevenueChartInstance.current.destroy();
          }
          
          const ctx = spendRevenueChartRef.current.getContext('2d');
          spendRevenueChartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: platforms,
              datasets: [
                {
                  label: 'Spend',
                  data: platforms.map(p => metrics[p].spend),
                  backgroundColor: '#EF4444',
                  borderRadius: 8,
                },
                {
                  label: 'Revenue',
                  data: platforms.map(p => metrics[p].revenue),
                  backgroundColor: '#10B981',
                  borderRadius: 8,
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: true,
                  text: 'Spend vs Revenue by Platform',
                  font: { size: 14, weight: 'normal' }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '$' + (value/1000).toFixed(0) + 'k';
                    }
                  }
                }
              }
            }
          });
        }

        // Conversion Rate Chart
        if (conversionChartRef.current) {
          if (conversionChartInstance.current) {
            conversionChartInstance.current.destroy();
          }
          
          const ctx = conversionChartRef.current.getContext('2d');
          conversionChartInstance.current = new Chart(ctx, {
            type: 'horizontalBar',
            data: {
              labels: platforms.sort((a, b) => metrics[b].conversionRate - metrics[a].conversionRate),
              datasets: [{
                label: 'Conversion Rate (%)',
                data: platforms.sort((a, b) => metrics[b].conversionRate - metrics[a].conversionRate)
                              .map(p => metrics[p].conversionRate),
                backgroundColor: '#6366F1',
                borderRadius: 8,
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Conversion Rate by Platform',
                  font: { size: 14, weight: 'normal' }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: 15,
                  ticks: {
                    callback: function(value) {
                      return value + '%';
                    }
                  }
                }
              }
            }
          });
        }

        return () => {
          if (roasChartInstance.current) roasChartInstance.current.destroy();
          if (spendRevenueChartInstance.current) spendRevenueChartInstance.current.destroy();
          if (conversionChartInstance.current) conversionChartInstance.current.destroy();
        };
      }, [metrics]);

      if (!metrics || Object.keys(metrics).length === 0) return null;

      // Calculate summary metrics
      const totalSpend = Object.values(metrics).reduce((sum, m) => sum + m.spend, 0);
      const totalRevenue = Object.values(metrics).reduce((sum, m) => sum + m.revenue, 0);
      const overallROAS = (totalRevenue / totalSpend).toFixed(2);
      const totalConversions = Object.values(metrics).reduce((sum, m) => sum + m.conversions, 0);

      return React.createElement('div', { className: 'mt-6 bg-white rounded-xl border border-gray-200 p-6' },
        // Summary Cards
        React.createElement('div', { className: 'grid grid-cols-4 gap-4 mb-6' },
          React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
            React.createElement('div', { className: 'text-xs text-gray-500 mb-1' }, 'Total Spend'),
            React.createElement('div', { className: 'text-xl font-semibold' }, '$' + (totalSpend/1000).toFixed(1) + 'k')
          ),
          React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
            React.createElement('div', { className: 'text-xs text-gray-500 mb-1' }, 'Total Revenue'),
            React.createElement('div', { className: 'text-xl font-semibold text-green-600' }, '$' + (totalRevenue/1000).toFixed(1) + 'k')
          ),
          React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
            React.createElement('div', { className: 'text-xs text-gray-500 mb-1' }, 'Overall ROAS'),
            React.createElement('div', { className: 'text-xl font-semibold text-blue-600' }, overallROAS + 'x')
          ),
          React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4' },
            React.createElement('div', { className: 'text-xs text-gray-500 mb-1' }, 'Conversions'),
            React.createElement('div', { className: 'text-xl font-semibold' }, totalConversions.toLocaleString())
          )
        ),
        
        // Charts Grid
        React.createElement('div', { className: 'grid grid-cols-2 gap-6' },
          React.createElement('div', { className: 'chart-container' },
            React.createElement('canvas', { ref: roasChartRef })
          ),
          React.createElement('div', { className: 'chart-container' },
            React.createElement('canvas', { ref: spendRevenueChartRef })
          )
        ),
        React.createElement('div', { className: 'mt-6' },
          React.createElement('div', { className: 'chart-container' },
            React.createElement('canvas', { ref: conversionChartRef })
          )
        )
      );
    }

    function AdAgentOS() {
      const [messages, setMessages] = useState([
        { role: 'assistant', content: 'Hello! I\'m your AI performance analyst. Ask me about your video ad campaigns.' }
      ]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [showAgents, setShowAgents] = useState(false);
      const [activeAgent, setActiveAgent] = useState(null);
      const messagesEndRef = useRef(null);

      const [agentPrompts, setAgentPrompts] = useState({
        dataAgent: 'You are a data retrieval specialist. Parse user intent and generate SQL queries.',
        analysisAgent: 'You are a performance analysis expert. Calculate ROAS, CTR, CPA metrics.',
        optimizationAgent: 'You are a marketing optimization specialist. Generate actionable recommendations.'
      });

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const handleSend = async () => {
        if (!input.trim()) return;

        const userMessage = input;
        setInput('');
        setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
        setIsLoading(true);

        try {
          const response = await fetch('https://adagentos-backend-production.up.railway.app/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              message: userMessage,
              agentPrompts 
            })
          });

          const data = await response.json();
          setMessages(prev => [...prev, { 
            role: 'assistant', 
            content: data.message || 'No response received',
            metrics: data.metrics 
          }]);
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, { 
            role: 'assistant', 
            content: 'Error connecting to backend. Please check console.' 
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      };

      const renderMarkdown = (text) => {
        const html = marked.parse(text);
        return React.createElement('div', {
          className: 'markdown-content',
          dangerouslySetInnerHTML: { __html: html }
        });
      };

      return React.createElement('div', { className: 'flex h-screen bg-white' },
        React.createElement('div', { className: 'flex-1 flex flex-col' },
          React.createElement('div', { className: 'border-b border-gray-100 px-8 py-6' },
            React.createElement('div', { className: 'flex items-center justify-between' },
              React.createElement('div', null,
                React.createElement('h1', { className: 'text-2xl font-light text-gray-900' }, 'AdAgentOS'),
                React.createElement('p', { className: 'text-sm text-gray-500 mt-1' }, 'AI Performance Analyst')
              ),
              React.createElement('button', {
                onClick: () => setShowAgents(!showAgents),
                className: 'p-2 hover:bg-gray-50 rounded-lg transition-colors'
              }, React.createElement('span', null, '⚙️'))
            )
          ),
          React.createElement('div', { className: 'flex-1 overflow-y-auto px-8 py-6' },
            React.createElement('div', { className: 'max-w-4xl mx-auto space-y-6' },
              messages.map((message, idx) => 
                React.createElement('div', { key: idx },
                  React.createElement('div', { 
                    className: `flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}` 
                  },
                    React.createElement('div', { 
                      className: `max-w-2xl ${message.role === 'user' ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'} rounded-2xl px-6 py-4` 
                    },
                      message.role === 'user' 
                        ? React.createElement('p', { className: 'text-sm leading-relaxed' }, message.content)
                        : renderMarkdown(message.content)
                    )
                  ),
                  message.metrics && Object.keys(message.metrics).length > 0 && 
                    React.createElement(ChartDisplay, { metrics: message.metrics })
                )
              ),
              isLoading && React.createElement('div', { className: 'flex justify-start' },
                React.createElement('div', { className: 'bg-gray-50 rounded-2xl px-6 py-4' },
                  React.createElement('div', { className: 'flex items-center space-x-2' },
                    React.createElement('div', { className: 'w-2 h-2 bg-gray-400 rounded-full animate-pulse' }),
                    React.createElement('div', { className: 'w-2 h-2 bg-gray-400 rounded-full animate-pulse', style: { animationDelay: '150ms' } }),
                    React.createElement('div', { className: 'w-2 h-2 bg-gray-400 rounded-full animate-pulse', style: { animationDelay: '300ms' } })
                  )
                )
              ),
              React.createElement('div', { ref: messagesEndRef })
            )
          ),
          React.createElement('div', { className: 'border-t border-gray-100 px-8 py-6' },
            React.createElement('div', { className: 'max-w-4xl mx-auto' },
              React.createElement('div', { className: 'flex items-end space-x-4' },
                React.createElement('textarea', {
                  value: input,
                  onChange: (e) => setInput(e.target.value),
                  onKeyPress: handleKeyPress,
                  placeholder: 'Ask about campaign performance...',
                  className: 'flex-1 px-4 py-3 bg-gray-50 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-gray-200',
                  rows: '1',
                  style: { minHeight: '48px' }
                }),
                React.createElement('button', {
                  onClick: handleSend,
                  disabled: isLoading || !input.trim(),
                  className: 'p-3 bg-gray-900 text-white rounded-xl hover:bg-gray-800 disabled:opacity-50'
                }, React.createElement('span', null, '➤'))
              ),
              React.createElement('div', { className: 'mt-3 flex space-x-6 text-xs text-gray-400' },
                React.createElement('span', null, 'Try: "Give me a cross channel summary"'),
                React.createElement('span', null, '•'),
                React.createElement('span', null, '"Which platform has the best ROAS?"'),
                React.createElement('span', null, '•'),
                React.createElement('span', null, '"Where should I reallocate budget?"')
              )
            )
          )
        ),
        showAgents && React.createElement('div', { className: 'w-96 border-l border-gray-100 bg-gray-50 p-6' },
          React.createElement('h2', { className: 'text-lg font-light mb-6' }, 'Agent Configuration'),
          Object.entries(agentPrompts).map(([agent, prompt]) =>
            React.createElement('div', { key: agent, className: 'mb-4 bg-white rounded-xl p-4' },
              React.createElement('button', {
                onClick: () => setActiveAgent(activeAgent === agent ? null : agent),
                className: 'w-full flex items-center justify-between mb-3 text-sm font-medium'
              }, agent, React.createElement('span', null, activeAgent === agent ? '▼' : '▶')),
              activeAgent === agent && React.createElement('textarea', {
                value: prompt,
                onChange: (e) => setAgentPrompts(prev => ({...prev, [agent]: e.target.value})),
                className: 'w-full h-24 p-2 text-xs bg-gray-50 rounded'
              })
            )
          )
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(AdAgentOS));
  </script>
</body>
</html>
